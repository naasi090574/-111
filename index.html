<div id="FX_ROOT">
  <style>
    /* ====== Editor UI (inside Genially) ====== */
    #fx-audio-editor{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      width:min(980px, 96vw);
      margin:0 auto;
      background:rgba(255,255,255,.92);
      border-radius:18px;
      box-shadow:0 12px 40px rgba(0,0,0,.15);
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
    }
    #fx-audio-editor .hdr{
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:linear-gradient(180deg, rgba(250,250,250,.98), rgba(245,245,245,.92));
      border-bottom:1px solid rgba(0,0,0,.07);
    }
    #fx-audio-editor .hdr h3{
      margin:0;
      font-size:14px;
      font-weight:700;
      letter-spacing:.2px;
    }
    #fx-audio-editor .hdr .hint{
      font-size:12px;
      color:rgba(0,0,0,.55);
    }
    #fx-audio-editor .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap:14px;
      padding:14px;
    }
    @media (max-width: 880px){
      #fx-audio-editor .grid{ grid-template-columns:1fr; }
    }
    .fx-card{
      background:rgba(255,255,255,.9);
      border:1px solid rgba(0,0,0,.08);
      border-radius:16px;
      padding:12px;
    }
    .fx-row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .fx-field{ margin-bottom:10px; }
    .fx-field label{
      display:block;
      font-size:12px;
      font-weight:650;
      margin:0 0 6px;
      color:rgba(0,0,0,.75);
    }
    .fx-field input[type="text"],
    .fx-field input[type="number"],
    .fx-field textarea,
    .fx-field select{
      width:100%;
      box-sizing:border-box;
      border:1px solid rgba(0,0,0,.14);
      border-radius:12px;
      padding:10px 10px;
      font-size:13px;
      outline:none;
      background:#fff;
    }
    .fx-field textarea{ min-height:128px; resize:vertical; }
    .fx-field input[type="range"]{ width:100%; }
    .fx-inline{
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:12px;
      color:rgba(0,0,0,.72);
    }
    .fx-inline input[type="checkbox"]{ transform: translateY(1px); }
    .fx-btns{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .fx-btn{
      appearance:none;
      border:none;
      border-radius:14px;
      padding:10px 12px;
      font-weight:700;
      font-size:13px;
      cursor:pointer;
      background:#111;
      color:#fff;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }
    .fx-btn.secondary{
      background:#fff;
      color:#111;
      border:1px solid rgba(0,0,0,.14);
      box-shadow:none;
    }
    .fx-btn:active{ transform: translateY(1px); }
    .fx-small{
      font-size:12px;
      color:rgba(0,0,0,.6);
      line-height:1.35;
      margin-top:8px;
    }
    .fx-code{
      width:100%;
      box-sizing:border-box;
      border:1px dashed rgba(0,0,0,.22);
      border-radius:14px;
      padding:10px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      min-height:130px;
      background:rgba(250,250,250,.9);
      white-space:pre;
      overflow:auto;
    }
    .fx-previewWrap{
      height:420px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(0,0,0,.08);
      background: radial-gradient(1200px 600px at 20% 10%, rgba(180,140,255,.22), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(255,120,160,.22), transparent 55%),
                  radial-gradient(900px 500px at 50% 85%, rgba(110,220,255,.18), transparent 60%),
                  linear-gradient(180deg, rgba(10,12,18,.86), rgba(10,12,18,.72));
      position:relative;
    }
    .fx-previewWrap::before{
      content:"PREVIEW (как будет в Genially)";
      position:absolute;
      left:12px; top:10px;
      font-size:11px;
      letter-spacing:.12em;
      color:rgba(255,255,255,.58);
      z-index:2;
      pointer-events:none;
    }
    .fx-preview{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background:transparent;
    }
  </style>

  <div id="fx-audio-editor">
    <div class="hdr">
      <div>
        <h3>Редактор аудиоплеера для Genially</h3>
        <div class="hint">Список треков → Сгенерировать → Скопировать iframe</div>
      </div>
      <div class="hint">Прозрачный фон • Prev/Next • Плейлист • Громкость</div>
    </div>

    <div class="grid">
      <div class="fx-card">
        <div class="fx-field">
          <label>Список треков (по 1 в строке)</label>
          <textarea id="fxTracks" placeholder="ФОРМАТ:
url|название|обложка(optional)
Пример:
https://.../song1.mp3|Song 1|https://.../cover1.png
https://.../song2.mp3|Song 2|"></textarea>
          <div class="fx-small">
            Нужны <b>прямые ссылки</b> на mp3/ogg/wav. “Ссылка на папку” не сработает без отдельного index.json.
          </div>
        </div>

        <div class="fx-row">
          <div class="fx-field">
            <label>Картинка по умолчанию (если у трека нет обложки)</label>
            <input id="fxDefaultCover" type="text" placeholder="https://.../default-cover.png">
          </div>
          <div class="fx-field">
            <label>Заголовок/проект (необязательно)</label>
            <input id="fxTitle" type="text" placeholder="Напр.: Радость • Плейлист">
          </div>
        </div>

        <div class="fx-row">
          <div class="fx-field">
            <label>Акцентный цвет</label>
            <input id="fxAccent" type="text" value="#ff5aa5" placeholder="#ff5aa5">
          </div>
          <div class="fx-field">
            <label>Размер плеера</label>
            <select id="fxSize">
              <option value="compact">Компактный</option>
              <option value="normal" selected>Обычный</option>
              <option value="large">Крупный</option>
            </select>
          </div>
        </div>

        <div class="fx-row">
          <div class="fx-field">
            <label>Скругление (px)</label>
            <input id="fxRadius" type="number" min="8" max="40" value="26">
          </div>
          <div class="fx-field">
            <label>Размытие фона (blur)</label>
            <input id="fxBlur" type="range" min="0" max="24" value="14">
          </div>
        </div>

        <div class="fx-field">
          <label>Показывать элементы</label>
          <div class="fx-inline">
            <label><input id="fxShowTimers" type="checkbox" checked> Таймеры</label>
            <label><input id="fxShowProgress" type="checkbox" checked> Прогресс</label>
            <label><input id="fxShowVolume" type="checkbox" checked> Громкость</label>
            <label><input id="fxShowPlaylist" type="checkbox" checked> Кнопка «Плейлист»</label>
          </div>
        </div>

        <div class="fx-btns">
          <button class="fx-btn" id="fxBuild">СГЕНЕРИРОВАТЬ</button>
          <button class="fx-btn secondary" id="fxCopy">КОПИРОВАТЬ IFRAME</button>
          <button class="fx-btn secondary" id="fxTest">Обновить предпросмотр</button>
        </div>

        <div class="fx-field" style="margin-top:12px;">
          <label>Готовый код для вставки в Genially</label>
          <div class="fx-code" id="fxOut" contenteditable="true" spellcheck="false"></div>
          <div class="fx-small">Подсказка: после вставки в Genially растяни элемент на нужный размер и поставь «На передний план».</div>
        </div>
      </div>

      <div class="fx-card">
        <div class="fx-previewWrap">
          <iframe class="fx-preview" id="fxPreview"></iframe>
        </div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    const $ = (id)=>document.getElementById(id);

    const defaults = {
      tracks: "",
      defaultCover: "",
      title: "",
      accent: "#ff5aa5",
      size: "normal",
      radius: 26,
      blur: 14,
      showTimers: true,
      showProgress: true,
      showVolume: true,
      showPlaylist: true
    };

    function parseTracks(text){
      const lines = (text||"").split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out = [];
      for(const line of lines){
        const parts = line.split("|").map(s=>s.trim());
        const url = parts[0] || "";
        if(!/^https?:\/\//i.test(url)) continue;
        out.push({
          url,
          title: parts[1] || "Track",
          cover: parts[2] || ""
        });
      }
      return out;
    }

    function escAttr(s){
      return String(s)
        .replace(/&/g,"&amp;")
        .replace(/"/g,"&quot;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;");
    }

    function buildPlayerSrcdoc(cfg){
      const tracks = parseTracks(cfg.tracks);
      const payload = {
        title: cfg.title || "",
        accent: cfg.accent || "#ff5aa5",
        size: cfg.size || "normal",
        radius: Number(cfg.radius||26),
        blur: Number(cfg.blur||14),
        showTimers: !!cfg.showTimers,
        showProgress: !!cfg.showProgress,
        showVolume: !!cfg.showVolume,
        showPlaylist: !!cfg.showPlaylist,
        defaultCover: cfg.defaultCover || "",
        tracks
      };

      const json = JSON.stringify(payload);

      return `<!doctype html><html><head><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  html,body{
    margin:0; width:100%; height:100%;
    background:transparent;
    overflow:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  :root{ --accent:#ff5aa5; --r:26px; --blur:14px; --fg:rgba(255,255,255,.92); --mut:rgba(255,255,255,.62); }
  .fx-wrap{
    position:absolute; inset:0;
    display:flex; align-items:center; justify-content:center;
    pointer-events:none;
  }
  .fx-player{
    pointer-events:auto;
    width:min(760px, 96vw);
    box-sizing:border-box;
    border-radius: var(--r);
    padding: 14px 14px;
    color:var(--fg);
    background: rgba(255,255,255,.10);
    backdrop-filter: blur(var(--blur));
    -webkit-backdrop-filter: blur(var(--blur));
    border: 1px solid rgba(255,255,255,.18);
    box-shadow: 0 18px 60px rgba(0,0,0,.35);
  }
  .size-compact{ width:min(560px, 96vw); padding:12px; }
  .size-large{ width:min(880px, 96vw); padding:16px; }

  .top{
    display:flex; align-items:center; gap:12px;
  }
  .cover{
    width:72px; height:72px; border-radius:18px;
    background:rgba(255,255,255,.14);
    overflow:hidden; flex:0 0 auto;
    border:1px solid rgba(255,255,255,.18);
  }
  .cover img{ width:100%; height:100%; object-fit:cover; display:block; }
  .meta{ flex:1 1 auto; min-width:0; }
  .project{
    font-size:11px; letter-spacing:.14em; text-transform:uppercase;
    color: rgba(255,255,255,.58);
    margin-bottom:4px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .track{
    font-size:15px; font-weight:750;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }

  .controls{
    display:flex; align-items:center; gap:10px;
    margin-top:12px;
  }
  .btn{
    width:44px; height:44px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    display:grid; place-items:center;
    cursor:pointer;
    user-select:none;
    transition: transform .08s ease, background .2s ease;
  }
  .btn:active{ transform: translateY(1px) scale(.99); }
  .btn svg{ width:20px; height:20px; fill: rgba(255,255,255,.92); }
  .btn.main{
    width:52px; height:52px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), rgba(0,0,0,.25));
    border-color: rgba(255,255,255,.22);
    box-shadow: 0 10px 30px rgba(0,0,0,.28);
  }

  .seek{
    flex:1 1 auto;
    display:flex; align-items:center; gap:10px;
    min-width:120px;
  }
  .time{
    font-size:12px; color: rgba(255,255,255,.72);
    font-variant-numeric: tabular-nums;
    min-width:44px; text-align:center;
  }
  input[type="range"]{
    -webkit-appearance:none; appearance:none;
    height:4px; border-radius:999px;
    background: rgba(255,255,255,.28);
    outline:none;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; appearance:none;
    width:14px; height:14px; border-radius:50%;
    background: var(--accent);
    border:2px solid rgba(255,255,255,.75);
    box-shadow: 0 8px 18px rgba(0,0,0,.25);
    cursor:pointer;
  }

  .right{
    display:flex; align-items:center; gap:10px;
  }
  .vol{ width:110px; }
  .pill{
    height:38px; padding:0 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.18);
    color:rgba(255,255,255,.92);
    font-weight:700;
    font-size:12px;
    cursor:pointer;
  }

  .playlist{
    margin-top:12px;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.20);
    overflow:hidden;
    max-height:0;
    transition:max-height .25s ease;
  }
  .playlist.open{ max-height: 240px; }
  .plist{
    max-height:240px;
    overflow:auto;
  }
  .item{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    cursor:pointer;
    border-top:1px solid rgba(255,255,255,.10);
  }
  .item:first-child{ border-top:none; }
  .dot{
    width:8px; height:8px; border-radius:50%;
    background: rgba(255,255,255,.35);
  }
  .item.active .dot{ background: var(--accent); box-shadow: 0 0 0 6px rgba(255,90,165,.18); }
  .ttl{
    flex:1 1 auto;
    font-size:13px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    color: rgba(255,255,255,.9);
  }
  .muted{ color: rgba(255,255,255,.62); font-size:12px; }

  /* optional visibility */
  .hideTimers .time{ display:none; }
  .hideProgress .seek{ display:none; }
  .hideVolume .vol{ display:none; }
  .hidePlaylistBtn #btnPlaylist{ display:none; }

  /* scrollbar */
  .plist::-webkit-scrollbar{ width:10px; }
  .plist::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius:999px; border:2px solid rgba(0,0,0,0); background-clip: padding-box; }
</style>
</head>
<body>
<div class="fx-wrap">
  <div class="fx-player" id="player">
    <div class="top">
      <div class="cover"><img id="cover" alt="" /></div>
      <div class="meta">
        <div class="project" id="project"></div>
        <div class="track" id="trackTitle">—</div>
      </div>
      <button class="pill" id="btnPlaylist" type="button">Плейлист</button>
    </div>

    <div class="controls">
      <div class="btn" id="btnPrev" title="Назад">
        <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6 10-6v12l-10-6z"/></svg>
      </div>
      <div class="btn main" id="btnPlay" title="Пуск/Пауза">
        <svg id="icoPlay" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        <svg id="icoPause" viewBox="0 0 24 24" style="display:none"><path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/></svg>
      </div>
      <div class="btn" id="btnNext" title="Вперёд">
        <svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2V6zM4.5 18V6l10 6-10 6z"/></svg>
      </div>

      <div class="seek">
        <div class="time" id="tCur">0:00</div>
        <input id="rngSeek" type="range" min="0" max="1000" value="0" />
        <div class="time" id="tDur">0:00</div>
      </div>

      <div class="right">
        <input class="vol" id="rngVol" type="range" min="0" max="100" value="80" />
      </div>
    </div>

    <div class="playlist" id="playlistBox">
      <div class="plist" id="plist"></div>
    </div>

    <audio id="aud" preload="metadata"></audio>
  </div>
</div>

<script>
(function(){
  const CFG = ${json};

  const elPlayer = document.getElementById('player');
  const elProject = document.getElementById('project');
  const elTrackTitle = document.getElementById('trackTitle');
  const elCover = document.getElementById('cover');
  const elAud = document.getElementById('aud');

  const btnPlay = document.getElementById('btnPlay');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnPlaylist = document.getElementById('btnPlaylist');
  const playlistBox = document.getElementById('playlistBox');
  const plist = document.getElementById('plist');

  const icoPlay = document.getElementById('icoPlay');
  const icoPause = document.getElementById('icoPause');

  const rngSeek = document.getElementById('rngSeek');
  const rngVol = document.getElementById('rngVol');
  const tCur = document.getElementById('tCur');
  const tDur = document.getElementById('tDur');

  const tracks = Array.isArray(CFG.tracks) ? CFG.tracks : [];
  let idx = 0;
  let seeking = false;

  // theme
  document.documentElement.style.setProperty('--accent', CFG.accent || '#ff5aa5');
  document.documentElement.style.setProperty('--r', (CFG.radius||26) + 'px');
  document.documentElement.style.setProperty('--blur', (CFG.blur||14) + 'px');

  elPlayer.classList.toggle('size-compact', CFG.size === 'compact');
  elPlayer.classList.toggle('size-large', CFG.size === 'large');

  if(!CFG.showTimers) elPlayer.classList.add('hideTimers');
  if(!CFG.showProgress) elPlayer.classList.add('hideProgress');
  if(!CFG.showVolume) elPlayer.classList.add('hideVolume');
  if(!CFG.showPlaylistBtn){} // not used
  if(!CFG.showPlaylist) elPlayer.classList.add('hidePlaylistBtn');

  elProject.textContent = CFG.title || '';
  elProject.style.display = CFG.title ? 'block' : 'none';

  function fmt(sec){
    if(!isFinite(sec) || sec < 0) return '0:00';
    sec = Math.floor(sec);
    const m = Math.floor(sec/60);
    const s = sec%60;
    return m + ':' + String(s).padStart(2,'0');
  }

  function setIcons(isPlaying){
    icoPlay.style.display = isPlaying ? 'none' : 'block';
    icoPause.style.display = isPlaying ? 'block' : 'none';
  }

  function coverFor(track){
    return track.cover || CFG.defaultCover || '';
  }

  function loadTrack(i, autoplay){
    if(!tracks.length){
      elTrackTitle.textContent = 'Добавь треки в редакторе';
      elCover.src = CFG.defaultCover || '';
      elAud.removeAttribute('src');
      setIcons(false);
      return;
    }
    idx = (i + tracks.length) % tracks.length;
    const tr = tracks[idx];
    elTrackTitle.textContent = tr.title || ('Track ' + (idx+1));
    const c = coverFor(tr);
    elCover.src = c || '';
    elAud.src = tr.url;
    elAud.load();
    highlight();
    if(autoplay) elAud.play().catch(()=>{});
  }

  function buildPlaylist(){
    plist.innerHTML = '';
    tracks.forEach((tr, i)=>{
      const row = document.createElement('div');
      row.className = 'item';
      row.innerHTML = '<div class="dot"></div><div class="ttl"></div><div class="muted">'+(i+1)+'</div>';
      row.querySelector('.ttl').textContent = tr.title || ('Track ' + (i+1));
      row.addEventListener('click', ()=>{
        loadTrack(i, true);
      });
      plist.appendChild(row);
    });
    highlight();
  }

  function highlight(){
    const items = plist.querySelectorAll('.item');
    items.forEach((it, i)=> it.classList.toggle('active', i===idx));
  }

  btnPlay.addEventListener('click', ()=>{
    if(!elAud.src){ loadTrack(0, true); return; }
    if(elAud.paused) elAud.play().catch(()=>{});
    else elAud.pause();
  });

  btnPrev.addEventListener('click', ()=> loadTrack(idx-1, true));
  btnNext.addEventListener('click', ()=> loadTrack(idx+1, true));

  btnPlaylist.addEventListener('click', ()=>{
    playlistBox.classList.toggle('open');
  });

  elAud.addEventListener('play', ()=> setIcons(true));
  elAud.addEventListener('pause', ()=> setIcons(false));
  elAud.addEventListener('ended', ()=> loadTrack(idx+1, true));

  elAud.addEventListener('loadedmetadata', ()=>{
    tDur.textContent = fmt(elAud.duration);
  });

  elAud.addEventListener('timeupdate', ()=>{
    if(seeking) return;
    tCur.textContent = fmt(elAud.currentTime);
    if(isFinite(elAud.duration) && elAud.duration>0){
      rngSeek.value = Math.round((elAud.currentTime / elAud.duration) * 1000);
    }else{
      rngSeek.value = 0;
    }
  });

  rngSeek.addEventListener('input', ()=>{
    seeking = true;
  });

  rngSeek.addEventListener('change', ()=>{
    if(isFinite(elAud.duration) && elAud.duration>0){
      const p = Number(rngSeek.value)/1000;
      elAud.currentTime = p * elAud.duration;
    }
    seeking = false;
  });

  rngVol.addEventListener('input', ()=>{
    elAud.volume = Number(rngVol.value)/100;
  });

  // init
  elAud.volume = Number(rngVol.value)/100;
  buildPlaylist();
  loadTrack(0, false);
})();
</script>
</body></html>`;
    }

    function getCfgFromUI(){
      return {
        tracks: $("fxTracks").value.trim(),
        defaultCover: $("fxDefaultCover").value.trim(),
        title: $("fxTitle").value.trim(),
        accent: $("fxAccent").value.trim() || defaults.accent,
        size: $("fxSize").value,
        radius: $("fxRadius").value,
        blur: $("fxBlur").value,
        showTimers: $("fxShowTimers").checked,
        showProgress: $("fxShowProgress").checked,
        showVolume: $("fxShowVolume").checked,
        showPlaylist: $("fxShowPlaylist").checked
      };
    }

    function buildIframeCode(cfg){
      const srcdoc = buildPlayerSrcdoc(cfg);
      // IMPORTANT: must escape for attribute
      const iframe = `<iframe style="border:0;width:100%;height:100%;background:transparent;" allow="autoplay" srcdoc="${escAttr(srcdoc)}"></iframe>`;
      return iframe;
    }

    function render(){
      const cfg = getCfgFromUI();
      const code = buildIframeCode(cfg);
      $("fxOut").textContent = code;
      $("fxPreview").setAttribute("srcdoc", buildPlayerSrcdoc(cfg));
    }

    function copy(){
      const codeEl = $("fxOut");
      const text = codeEl.textContent || "";
      const range = document.createRange();
      range.selectNodeContents(codeEl);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
      try{
        document.execCommand('copy');
      }catch(e){}
      sel.removeAllRanges();
    }

    $("fxBuild").addEventListener("click", render);
    $("fxTest").addEventListener("click", render);
    $("fxCopy").addEventListener("click", ()=>{ render(); copy(); });

    // Pre-fill example (so you immediately see how it looks)
    if(!$("fxTracks").value.trim()){
      $("fxTracks").value =
`https://example.com/audio/song1.mp3|Song 1|https://example.com/img/cover1.png
https://example.com/audio/song2.mp3|Song 2|
https://example.com/audio/song3.mp3|Song 3|https://example.com/img/cover3.png`;
    }
    render();
  })();
  </script>
</div>
